{"version":3,"sources":["../src/benchmarker.js"],"names":["chalk","require","jsdom","zlib","fs","vm","getTime","stamp","process","hrtime","exec","code","compatibility","sandbox","setTimeout","setInterval","console","error","log","s","beforeCode","afterCode","window","defaultView","document","navigator","location","start","script","Script","cachedDataProduced","executedStart","runInNewContext","executedEnd","raw","length","gzip","gzipSync","executed","compiled","total","line","type","moreOut","compareStats","undefined","stats","wrapTime","key","wrap","ms","toFixed","wrapSize","b","kilobytes","Math","round","format","positive","negative","before","after","factor","green","red","out","bold","dump","name","min","outputFilename","inverse","beforeStats","Date","now","realm","serialize","serializer","sources","filePath","fileContents","serialized","init","exit","filename","writeFileSync","args","Array","from","argv","splice","inputFilename","arg","shift","startsWith","input","readFileSync"],"mappings":"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","file":"benchmarker.js","sourcesContent":["/**\n * Copyright (c) 2017-present, Facebook, Inc.\n * All rights reserved.\n *\n * This source code is licensed under the BSD-style license found in the\n * LICENSE file in the root directory of this source tree. An additional grant\n * of patent rights can be found in the PATENTS file in the same directory.\n */\n\n/* @flow */\n\nimport type { Compatibility } from \"./options.js\";\nimport Serializer from \"./serializer/index.js\";\nimport construct_realm from \"./construct_realm.js\";\nimport initializeGlobals from \"./globals.js\";\nimport invariant from \"./invariant.js\";\n\nlet chalk = require(\"chalk\");\nlet jsdom = require(\"jsdom\");\nlet zlib = require(\"zlib\");\nlet fs = require(\"fs\");\nlet vm = require(\"vm\");\n\nfunction getTime() {\n  let stamp = process.hrtime();\n  return (stamp[0] * 1e9 + stamp[1]) / 1e6;\n}\n\nfunction exec(code: string, compatibility: Compatibility) {\n  let sandbox: any = {\n    setTimeout: setTimeout,\n    setInterval: setInterval,\n    console: {\n      error() {},\n      log(s) {\n        console.log(s);\n      },\n    },\n  };\n\n  let beforeCode = \"var global = this; \";\n  let afterCode = `// At the end of the script, Node tries to clone the 'this' Object (global) which involves executing all getters on it.\n// To avoid executing any more code (which could affect timing), we just set all globals to undefined (hoping that doesn't take too long).\nObject.getOwnPropertyNames(global).forEach(function(name){ if (name !== \"Object\" && name !== \"global\") global[name] = undefined; });`;\n\n  if (compatibility === \"browser\") {\n    beforeCode += \"var window = this; var self = this; \";\n    let window = jsdom.jsdom({}).defaultView;\n    sandbox.window = window;\n    sandbox.document = window.document;\n    sandbox.navigator = window.navigator;\n    sandbox.location = window.location;\n  }\n  if (compatibility === \"jsc-600-1-4-17\") {\n    beforeCode +=\n      \"delete global.clearInterval; delete global.clearImmediate; delete global.clearTimeout; delete global.setImmediate; delete Object.assign;\";\n  }\n\n  code = `${beforeCode} ${code}; // keep newline here as code may end with comment\n${afterCode}`;\n\n  let start = getTime();\n  let script = new vm.Script(code, { cachedDataProduced: false });\n  let executedStart = getTime();\n  script.runInNewContext(sandbox);\n  let executedEnd = getTime();\n\n  return {\n    raw: code.length,\n    gzip: zlib.gzipSync(code).length,\n    executed: executedEnd - executedStart,\n    compiled: executedStart - start,\n    total: executedEnd - start,\n  };\n}\n\nfunction line(type, code, compatibility: Compatibility, moreOut = {}, compareStats = undefined) {\n  let stats = exec(code, compatibility);\n\n  function wrapTime(key) {\n    return wrap(key, ms => `${ms.toFixed(2)}ms`, \"faster\", \"slower\");\n  }\n\n  function wrapSize(key) {\n    return wrap(\n      key,\n      function(b) {\n        let kilobytes = Math.round(b / 1000);\n        if (kilobytes > 1000) {\n          return `${(kilobytes / 1000).toFixed(2)}MB`;\n        } else {\n          return `${kilobytes}KB`;\n        }\n      },\n      \"smaller\",\n      \"bigger\"\n    );\n  }\n\n  function wrap(key, format, positive, negative) {\n    if (compareStats) {\n      let before = compareStats[key];\n      let after = stats[key];\n      let factor;\n\n      if (after < before) {\n        factor = chalk.green(`${(before / after).toFixed(2)}x ${positive}`);\n      } else {\n        factor = chalk.red(`${(after / before).toFixed(2)}x ${negative}`);\n      }\n\n      return `${format(after)} ${factor}`;\n    } else {\n      return format(stats[key]);\n    }\n  }\n\n  let out = {\n    \"VM Total Time\": wrapTime(\"total\"),\n    \"VM Compile Time\": wrapTime(\"compiled\"),\n    \"VM Execution Time\": wrapTime(\"executed\"),\n    \"Raw Code Size\": wrapSize(\"raw\"),\n    \"Gzip Code Size\": wrapSize(\"gzip\"),\n    ...moreOut,\n  };\n\n  console.log(chalk.bold(type));\n\n  for (let key in out) {\n    console.log(`  ${chalk.bold(key)} ${out[key]}`);\n  }\n\n  return stats;\n}\n\nfunction dump(\n  name: string,\n  raw: string,\n  min: string = raw,\n  compatibility?: \"browser\" | \"jsc-600-1-4-17\" = \"browser\",\n  outputFilename?: string\n) {\n  console.log(chalk.inverse(name));\n  let beforeStats = line(\"Before\", min, compatibility);\n\n  let start = Date.now();\n  let realm = construct_realm({ serialize: true, compatibility });\n  initializeGlobals(realm);\n  let serializer = new Serializer(realm);\n  let sources = [{ filePath: name, fileContents: raw }];\n  let serialized = serializer.init(sources);\n  if (!serialized) {\n    process.exit(1);\n    invariant(false);\n  }\n  let code = serialized.code;\n  let total = Date.now() - start;\n\n  if (code.length >= 1000 || outputFilename) {\n    let filename = outputFilename || name + \"-processed.js\";\n    console.log(`Prepacked source code written to ${filename}.`);\n    fs.writeFileSync(filename, code);\n  }\n\n  line(\n    \"After\",\n    code,\n    compatibility,\n    {\n      \"Prepack Compile Time\": `${total}ms`,\n    },\n    beforeStats\n  );\n\n  if (code.length <= 1000 && !outputFilename) {\n    console.log(\"+++++++++++++++++ Prepacked source code\");\n    console.log(code);\n    console.log(\"=================\");\n  }\n}\n\nlet args = Array.from(process.argv);\nargs.splice(0, 2);\nlet inputFilename;\nlet outputFilename;\nlet compatibility;\nwhile (args.length) {\n  let arg = args[0];\n  args.shift();\n  if (arg === \"--out\") {\n    arg = args[0];\n    args.shift();\n    outputFilename = arg;\n  } else if (arg === \"--compatibility\") {\n    arg = args[0];\n    args.shift();\n    if (arg !== \"jsc-600-1-4-17\") {\n      console.error(`Unsupported compatibility: ${arg}`);\n      process.exit(1);\n    } else {\n      compatibility = arg;\n    }\n  } else if (arg === \"--help\") {\n    console.log(\"Usage: benchmarker.js [ --out output.js ] [ --compatibility jsc ] [ -- | input.js ]\");\n  } else if (!arg.startsWith(\"--\")) {\n    inputFilename = arg;\n  } else {\n    console.error(`Unknown option: ${arg}`);\n    process.exit(1);\n  }\n}\n\nif (!inputFilename) {\n  console.error(\"Missing input file.\");\n  process.exit(1);\n} else {\n  let input = fs.readFileSync(inputFilename, \"utf8\");\n  dump(inputFilename, input, input, compatibility, outputFilename);\n}\n\n//dump(\"helloWorld\", \"function hello() { return 'hello'; } function world() { return 'world'; } s = hello() + ' ' + world();\");\n\n//dump(\"regex\", \"regex = /Facebook/i;\");\n\n//dump(\"test\", \"try { new WeakSet().delete.call(0, {}); } catch (e) {console.log(e);}\");\n//dump(\"test\", \"e = 'abcdef'.substr(1,2); \");\n//dump(\"test\", \"var s = 'Promise'; e = s[0];\");\n//dump(\"test\", \"foo = function() { return [,0]; };\");\n\n//dump(\"simple\", \"var foo = 5 * 5; var bar = [2, 3, 'yes']; var foo2 = null; var bar2 = undefined;\");\n//dump(\"simple2\", \"function Foo() {} Foo.prototype.wow = function () {};\");\n\n//dump(\"Date.now\", \"Date.now\");\n//dump(\"Date.now\", \"this.foo = Date.now();\");\n//dump(\"object recursion\", \"var obj = { yes: 'no' }; obj.bar = obj; var foo = [obj]; obj.foobar = foo;\");\n//dump(\"intrinsic union\", \"var assign = Object.assign || function () {}; var obj = assign({ foo: 1 }, { bar: 2 });\");\n\n/*dump(\n  \"fbsdk\",\n  fs.readFileSync(__dirname + \"/../assets/fbsdk.js\", \"utf8\")\n);*/\n\n/*dump(\n  \"react\",\n  fs.readFileSync(__dirname + \"/../assets/react.js\", \"utf8\"),\n  fs.readFileSync(__dirname + \"/../assets/react.min.js\", \"utf8\")\n);*/\n\n/*dump(\n  \"immutable\",\n  fs.readFileSync(__dirname + \"/../assets/immutable.js\", \"utf8\"),\n  fs.readFileSync(__dirname + \"/../assets/immutable.min.js\", \"utf8\")\n);*/\n\n/*dump(\n  \"react-native-bundle\",\n  fs.readFileSync(__dirname + \"/../../examples/react-native-bundle/bundle.js\", \"utf8\")\n);*/\n\n/*dump(\n  \"lodash\",\n  fs.readFileSync(require.resolve(\"lodash/lodash.js\"), \"utf8\"),\n  fs.readFileSync(require.resolve(\"lodash/lodash.min.js\"), \"utf8\")\n);*/\n\n/*dump(\n  \"underscore\",\n  fs.readFileSync(require.resolve(\"underscore\"), \"utf8\"),\n  fs.readFileSync(require.resolve(\"underscore/underscore-min\"), \"utf8\")\n);\n*/\n\n/*dump(\n  \"ember\",\n  fs.readFileSync(\"ember.prod.js\", \"utf8\")\n);\n\ndump(\n  \"jquery\",\n  fs.readFileSync(require.resolve(\"jquery/dist/jquery.js\"), \"utf8\"),\n  fs.readFileSync(require.resolve(\"jquery/dist/jquery.min.js\"), \"utf8\")\n);\n\ndump(\n  \"scrollin\",\n  fs.readFileSync(\"scrollin.js\", \"utf8\")\n);\n*/\n"]}